<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  
<style>
 :root {
 --bg-main: #1d232a;
 --bg-secondary: #2a323c;
 --bg-input: #191e24;
 --text-main: #e2e8f0;
 --text-muted: #718096;
 --accent-color: #0091A9;
 --accent-hover: #00a9c6;
 --border-color: #4a5568;
 --focus-shadow: rgba(0, 145, 169, 0.5);
 --error-color: #f87171;
 --success-color: #4ade80;
   --btn-secondary-bg: #6c757d; 
   --btn-secondary-hover: #5a6268;
 }
 body {
 padding: 24px;
 font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
 background-color: var(--bg-main);
 color: var(--text-main);
 line-height: 1.6;
 margin: 0;
 }
 h3 {
 font-size: 1.5em;
 font-weight: 300;
 color: var(--text-main);
 border-bottom: 2px solid var(--border-color);
 padding-bottom: 8px;
 margin-top: 0;
 }
 h3 strong {
  color: var(--accent-color);
  font-weight: 600;
 }
 h4 {
 font-size: 1.1em;
 color: var(--text-muted);
 margin-top: 24px;
 text-transform: uppercase;
 letter-spacing: 0.05em;
 }
  h4:first-of-type {
    margin-top: 0;
  }
 p {
 color: var(--text-muted);
 font-size: 0.95em;
 }
 a {
 color: var(--accent-color);
 text-decoration: none;
 transition: color 0.2s;
 }
 a:hover {
 color: var(--accent-hover);
 text-decoration: underline;
 }
 label {
  display: block;
  font-size: 0.9em;
  color: var(--text-muted);
  margin-bottom: 8px;
 }
 select {
  width: 100%;
  padding: 10px;
  font-size: 1em;
  background-color: var(--bg-input);
  color: var(--text-main);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 16px;
  box-sizing: border-box;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23718096%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 10px;
 }
 select:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px var(--focus-shadow);
 }
 select:disabled {
  opacity: 0.5;
  background-color: var(--bg-secondary);
 }
  .grid-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  @media (min-width: 900px) {
    .grid-container {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-section {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 24px;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .settings-grid-cols-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  
  input[type="text"],
  input[type="url"] {
    width: 100%;
    padding: 10px;
    font-size: 1em;
    background-color: var(--bg-input);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-sizing: border-box;
  }
  input[type="text"]:focus,
  input[type="url"]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px var(--focus-shadow);
  }

  .input-with-button {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .input-with-button input {
    flex-grow: 1;
  }
  .btn-open-url {
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    background-color: var(--border-color);
    color: var(--text-main);
    cursor: pointer;
    transition: background-color 0.2s;
    flex-shrink: 0;
    border: none;
    height: 42px;
  }
  .btn-open-url:hover {
    background-color: var(--bg-secondary);
  }

  .checkbox-wrapper {
    display: flex;
    align-items: center;
    background-color: var(--bg-input);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }
  .checkbox-wrapper input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
  }
  .checkbox-wrapper label {
    margin-bottom: 0;
    color: var(--text-main);
    font-size: 1em;
  }
  
  .preset-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 16px;
  }
  .preset-controls select {
    flex-grow: 1;
    margin-bottom: 0;
  }
  .btn-preset {
    padding: 10px 15px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    flex-shrink: 0;
  }
  .btn-save {
    background-color: var(--accent-color);
    color: white;
  }
  .btn-save:hover { background-color: var(--accent-hover); }
  
  .btn-delete {
    background-color: var(--btn-secondary-bg);
    color: white;
  }
  .btn-delete:hover { 
    background-color: var(--btn-secondary-hover); 
  }
  .btn-delete:disabled {
    background-color: var(--border-color);
    cursor: not-allowed;
    opacity: 0.7;
  }
  
  #prompt-area {
 width: 100%;
 height: 300px;
 margin-bottom: 16px;
 box-sizing: border-box;
 font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
 background-color: var(--bg-input);
 color: var(--text-muted);
 border: 1px solid var(--border-color);
 border-radius: 8px;
 padding: 12px;
 font-size: 0.9em;
 transition: border-color 0.2s, box-shadow 0.2s, color 0.2s;
 }
 #prompt-area.has-input {
  color: var(--text-main);
 }
 #prompt-area:focus {
 outline: none;
 border-color: var(--accent-color);
 box-shadow: 0 0 0 3px var(--focus-shadow);
 color: var(--text-main);
 }
 #submit-button {
 background-color: var(--accent-color);
 color: white;
 border: none;
 padding: 12px 24px;
 font-size: 16px;
 font-weight: bold;
 border-radius: 8px;
 cursor: pointer;
 transition: background-color 0.2s ease-in-out, transform 0.1s ease;
 width: 100%;
 box-sizing: border-box;
 }
 #submit-button:hover:not(:disabled) {
 background-color: var(--accent-hover);
 transform: translateY(-1px);
 }
 #submit-button:disabled {
 background-color: var(--border-color);
 color: var(--text-muted);
 cursor: not-allowed;
 opacity: 0.7;
 }
 .secondary-button {
 display: inline-block;
 background-color: transparent;
 color: var(--accent-color);
 border: 1px solid var(--accent-color);
 padding: 8px 16px;
 font-size: 14px;
 font-weight: 500;
 border-radius: 8px;
 cursor: pointer;
 text-decoration: none;
 transition: background-color 0.2s ease, color 0.2s ease;
 margin-bottom: 16px;
 }
 .secondary-button:hover {
 background-color: var(--focus-shadow);
 color: var(--text-main);
 text-decoration: none;
 }
 .secondary-button.is-loading {
 opacity: 0.5;
 cursor: not-allowed;
 color: var(--text-muted);
 border-color: var(--border-color);
 }
 #result {
 margin-top: 16px;
 padding: 16px;
 border: 1px dashed var(--border-color);
 background-color: var(--bg-secondary);
  min-height: 50px;
 word-wrap: break-word;
 border-radius: 8px;
 color: var(--text-muted);
 }
 #result b {
  color: var(--text-main);
 }
  
 .loading-icon, .success-icon, .error-icon {
  font-weight: bold;
  font-size: 1.2em;
  margin-right: 8px;
 }
 .loading-icon { color: var(--text-muted); }
 .success-icon { color: var(--success-color); }
 .error-icon { color: var(--error-color); }
 .error {
 color: var(--error-color);
 font-weight: bold;
 }
</style>
</head>
<body>

 <h3>Gãƒ•ã‚©ãƒ¼ãƒ å¼ç¥ <strong>v2</strong></h3>
 <p>ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œè¨­è¨ˆå›³ (JSON)ã€ã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

  <div class="grid-container">
    
    <div class="form-section">
      <h4>1. ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ</h4>
      <div class="preset-controls">
        <select id="presetSelect">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
        <button type="button" id="deletePresetBtn" class="btn-preset btn-delete" disabled>å‰Šé™¤</button>
      </div>

      <h4>2. è¨­è¨ˆå›³ (JSON) ã‚’å…¥åŠ›</h4>
      <a id="gem-link" href="#" target="_blank" rel="noopener noreferrer" class="secondary-button is-loading">
       â³ (v1) å¼ç¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      </a>
     <textarea id="prompt-area">{
       "title": "ï¼ˆã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘ï¼‰",
       "description": "ãƒ†ã‚¹ãƒˆç”¨ã®JSONã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
       "items": [
        {
         "type": "text",
         "title": "ãŠåå‰",
         "required": true
        }
       ]
      }
      </textarea>
      
       <button id="submit-button" onclick="submitFormRequest()">
        ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰
       </button>
      
       <h4>å®Ÿè¡Œçµæœ</h4>
       <div id="result">
        ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
       </div>
    </div>
    
    <div class="form-section">
      <h4>ãƒ—ãƒªã‚»ãƒƒãƒˆã®ç®¡ç†</h4>
      <p>ç¾åœ¨ã®è¨­å®šå†…å®¹ã‚’ã€ŒGFå¼ç¥ã€ã‚·ãƒ¼ãƒˆã«ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚</p>
      
      <div class="settings-grid">
        <div>
          <label for="folderUrl">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URL</label>
          <div class="input-with-button">
            <input type="url" id="folderUrlInput" placeholder="https://drive.google.com/folders/...">
            <button type="button" class="btn-open-url" id="openFolderUrlBtn">é–‹ã</button>
          </div>
        </div>
        
        <div class="settings-grid-cols-2">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="collectEmailInput">
            <label for="collectEmailInput">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åé›†</label>
          </div>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="sendCopyInput">
            <label for="sendCopyInput">å›ç­”ã®ã‚³ãƒ”ãƒ¼ã‚’é€ä¿¡</label>
          </div>
        </div>

        <hr style="border-color: var(--border-color); border-top: 0; grid-column: 1 / -1;">
        
        <button type="button" id="savePresetBtn" class="btn-preset btn-save">
          ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜/æ›´æ–°
        </button>
      </div>
    </div>

  </div>


 <script>
  // =================================================================
  // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  // =================================================================
  const submitButton = document.getElementById('submit-button');
  const resultDiv = document.getElementById('result');
  const promptArea = document.getElementById('prompt-area');
  const gemLinkButton = document.getElementById('gem-link');
  const presetSelect = document.getElementById('presetSelect');
  let isPristine = true;
    let activeTimer = null; 
    let startTime = 0;      
    
    let userPresets = {};
    const savePresetBtn = document.getElementById('savePresetBtn');
    const deletePresetBtn = document.getElementById('deletePresetBtn');
    
    const folderUrlInput = document.getElementById('folderUrlInput');
    const collectEmailInput = document.getElementById('collectEmailInput');
    const sendCopyInput = document.getElementById('sendCopyInput');
    
    const openFolderUrlBtn = document.getElementById('openFolderUrlBtn');


  // =================================================================
  // 2. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å‡¦ç†
  // =================================================================
  document.addEventListener("DOMContentLoaded", () => {
   presetSelect.disabled = true;
   submitButton.disabled = true;
      deletePresetBtn.disabled = true;
   submitButton.innerText = "è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...";

   let initialPresets = null;
      let appSettings = null;

   try {
    initialPresets = <?!= JSON.stringify(presets) ?>;
        appSettings = <?!= JSON.stringify(appSettings) ?>;
   } catch (e) {
    console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—", e);
    onDataFailed(new Error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"));
    return;
   }

      if (appSettings && appSettings['å¼ç¥Gãƒ•ã‚©ãƒ¼ãƒ Gem']) {
        gemLinkButton.href = appSettings['å¼ç¥Gãƒ•ã‚©ãƒ¼ãƒ Gem'];
      gemLinkButton.innerHTML = "ğŸ“ å¼ç¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†/ã‚³ãƒ”ãƒ¼";
      gemLinkButton.classList.remove('is-loading');
      } else {
        onDataFailed(new Error("ã€Œè¨­å®šã€ã‚·ãƒ¼ãƒˆã‹ã‚‰ 'å¼ç¥Gãƒ•ã‚©ãƒ¼ãƒ Gem' URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"));
        return;
      }
      
      if (initialPresets) {
        userPresets = initialPresets;
        onDataLoaded();
      } else {
         onDataFailed(new Error("ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"));
      }

      presetSelect.addEventListener('change', loadSelectedPreset);
      savePresetBtn.addEventListener('click', saveCurrentPreset);
      deletePresetBtn.addEventListener('click', deleteSelectedPreset);
      
      openFolderUrlBtn.addEventListener('click', () => openUrl(folderUrlInput.value));
  });

  /**
  * (æˆåŠŸ) ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸ
  */
  function onDataLoaded() {
      updatePresetSelect();
      
      presetSelect.disabled = false;
      submitButton.disabled = false;
      submitButton.innerText = "ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰";
      resultDiv.innerHTML = "æº–å‚™å®Œäº†ã§ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã³ã€JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";

      if (presetSelect.options.length > 0 && presetSelect.options[0].value) {
        presetSelect.selectedIndex = 0; 
        loadSelectedPreset(); 
      }
  }

  /**
  * (å¤±æ•—) ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨­å®šèª­ã¿è¾¼ã¿ãŒå¤±æ•—ã—ãŸ
  */
  function onDataFailed(error) {
      if (gemLinkButton) {
      gemLinkButton.href = "javascript:void(0);";
      gemLinkButton.innerHTML = "âœ– (v1)è¨­å®šèª­è¾¼ã‚¨ãƒ©ãƒ¼";
      gemLinkButton.title = error.message;
      gemLinkButton.classList.remove('is-loading');
      }
   
   presetSelect.innerHTML = '<option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆèª­è¾¼ã‚¨ãƒ©ãƒ¼</option>';
   presetSelect.disabled = true;
   submitButton.disabled = true;
      deletePresetBtn.disabled = true;
   submitButton.innerText = "ã‚¨ãƒ©ãƒ¼";

    resultDiv.innerHTML = '<span class="error-icon">âœ–</span> <span class="error">åˆæœŸè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</span>';
  }

  // =================================================================
  // 3. ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®UXåˆ¶å¾¡
  // =================================================================
  promptArea.onfocus = function() {
   if (isPristine) {
    promptArea.value = '';
    promptArea.classList.add('has-input');
    isPristine = false;
   }
  };
  promptArea.oninput = function() {
   if (isPristine) {
    isPristine = false;
    promptArea.classList.add('has-input');
   }
  };

  // =================================================================
  // 4. ãƒ•ã‚©ãƒ¼ãƒ æ§‹ç¯‰ã®å®Ÿè¡Œ (ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½è¿½åŠ )
  // =================================================================
  function submitFormRequest() {
   const promptText = promptArea.value;
      const selectedPresetName = presetSelect.value; 

      if (!selectedPresetName) {
         showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error', 3000);
         return;
      }
      if (isPristine || promptText.trim() === '' || !promptText.trim().startsWith('{')) {
         showResult('è¨­è¨ˆå›³ (JSON) ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'error', 3000);
         return;
      }

   submitButton.disabled = true;
   submitButton.innerText = "æ§‹ç¯‰ä¸­...";
      
      startTime = Date.now();
      if (activeTimer) clearInterval(activeTimer);
      
      showResult('ã€Œ' + selectedPresetName + 'ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã§æ§‹ç¯‰ä¸­ã§ã™... (0.0ç§’)', 'loading');
      
      activeTimer = setInterval(() => {
        const elapsedSeconds = (Date.now() - startTime) / 1000;
        showResult('ã€Œ' + selectedPresetName + 'ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã§æ§‹ç¯‰ä¸­ã§ã™... (' + elapsedSeconds.toFixed(1) + 'ç§’)', 'loading');
      }, 500);

   google.script.run
    .withSuccessHandler(onFormCreateSuccess) 
    .withFailureHandler(onFormCreateFailure) 
    .processUserInput(promptText, selectedPresetName);
  }


    // â–¼â–¼â–¼ æˆåŠŸãƒãƒ³ãƒ‰ãƒ©ã‚’ä¿®æ­£ (QRã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›´) â–¼â–¼â–¼
  function onFormCreateSuccess(resultString) {
      if (activeTimer) clearInterval(activeTimer);
      const elapsedSeconds = (Date.now() - startTime) / 1000;
      
   submitButton.disabled = false;
   submitButton.innerText = "ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰";
  
   try {
    const result = JSON.parse(resultString);
   
    if (result.status === 'success') {
          // â–¼â–¼â–¼ æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰APIã®URLã‚’ç”Ÿæˆ â–¼â–¼â–¼
          const qrLink = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(result.publishedUrl);
          
     resultDiv.innerHTML =
      '<span class="success-icon">âœ”</span> <strong>ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼</strong> (çµŒé: ' + elapsedSeconds.toFixed(1) + 'ç§’)<br><br>' +
      '<b>å›ç­”ç”¨URL:</b> <a href="' + result.publishedUrl + '" target="_blank" rel="noopener noreferrer">' + result.publishedUrl + '</a><br>' +
            '<b>QRã‚³ãƒ¼ãƒ‰:</b> <a href="' + qrLink + '" target="_blank" rel="noopener noreferrer">QRã‚³ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</a><br>' +
      '<b>ç·¨é›†ç”¨URL:</b> <a href="' + result.editUrl + '" target="_blank" rel="noopener noreferrer">' + result.editUrl + '</a>';

    } else {
     onFormCreateFailure(new Error(result.message)); 
    }
   } catch (e) {
    onFormCreateFailure(e); 
   }
  }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

  function onFormCreateFailure(error) {
      if (activeTimer) clearInterval(activeTimer);
      const elapsedSeconds = (Date.now() - startTime) / 1000;
      
   submitButton.disabled = false;
   submitButton.innerText = "ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰";
      showResult('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + ' (çµŒé: ' + elapsedSeconds.toFixed(1) + 'ç§’)', 'error');
  }

    function showResult(message, type = 'info', duration = 0) {
      if (type !== 'loading') {
         if (activeTimer) clearInterval(activeTimer);
      }
      
      let icon = '';
      if (type === 'success') icon = '<span class="success-icon">âœ”</span> ';
      if (type === 'error') icon = '<span class="error-icon">âœ–</span> ';
      if (type === 'loading') icon = '<span class="loading-icon">â³</span> ';
      
      const typeClass = (type === 'error') ? 'error' : '';
      
      if (type !== 'success') {
        resultDiv.innerHTML = icon + '<span class="' + typeClass + '">' + message + '</span>';
      }
      
      if (duration > 0) {
        setTimeout(() => {
          if (resultDiv.innerText.includes(message)) { 
            resultDiv.innerHTML = 'ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
          }
        }, duration);
      }
    }

    function openUrl(url) {
      if (url && url.trim()) {
        window.open(url.trim(), '_blank');
      } else {
        showResult('URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error', 3000);
      }
    }


  // =================================================================
  // 5. ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†é–¢æ•°ç¾¤
  // =================================================================

    function updatePresetSelect() {
      const currentSelection = presetSelect.value;
      presetSelect.innerHTML = '';
      
      const presetNames = Object.keys(userPresets).sort();
      
      if (presetNames.length === 0) {
        presetSelect.innerHTML = '<option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        presetSelect.disabled = true;
        deletePresetBtn.disabled = true;
        return;
      }

      presetSelect.disabled = false;
      
      presetNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        presetSelect.appendChild(option);
      });

      if (currentSelection && userPresets[currentSelection]) {
        presetSelect.value = currentSelection;
      }
      
      deletePresetBtn.disabled = presetSelect.value === '';
    }

    function loadSelectedPreset() {
      const presetName = presetSelect.value;
      if (!presetName || !userPresets[presetName]) {
        deletePresetBtn.disabled = true;
        applySettingsToForm({});
        return;
      }
      
      const settings = userPresets[presetName];
      applySettingsToForm(settings);
      deletePresetBtn.disabled = false;
    }

    function applySettingsToForm(settings) {
      settings = settings || {}; 
      folderUrlInput.value = settings.folderUrl || '';
      collectEmailInput.checked = settings.collectEmail === true;
      sendCopyInput.checked = settings.sendCopy === true;
    }

    function getCurrentSettingsFromForm() {
      return {
        folderUrl: folderUrlInput.value.trim(),
        collectEmail: collectEmailInput.checked,
        sendCopy: sendCopyInput.checked
      };
    }
    
    function saveCurrentPreset() {
      const selectedPreset = presetSelect.value;
      const settings = getCurrentSettingsFromForm();
      
      let nameToSave = "";

      if (selectedPreset) {
        const newName = prompt(
          "ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nï¼ˆç©ºæ¬„ã§ã€Œ" + selectedPreset + "ã€ã‚’ä¸Šæ›¸ãä¿å­˜ã€åˆ¥åä¿å­˜ã‚‚å¯ï¼‰",
          selectedPreset 
        );
        
        if (newName === null) return; 
        
        nameToSave = newName.trim() || selectedPreset;

      } else {
        const newName = prompt("æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (newName === null || !newName.trim()) {
          showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error', 3000);
          return;
        }
        nameToSave = newName.trim();
      }

      showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ' + nameToSave + 'ã€ã‚’ä¿å­˜ä¸­...', 'loading');
      savePresetBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler(response => {
          savePresetBtn.disabled = false;
          if (response.status === 'success') {
            showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success', 3000);
            refreshPresets(nameToSave);
          } else {
            onFormCreateFailure(new Error(response.message));
          }
        })
        .withFailureHandler(error => {
          savePresetBtn.disabled = false;
          onFormCreateFailure(error);
        })
        .savePresetToSheet(nameToSave, settings);
    }

    function deleteSelectedPreset() {
      const presetName = presetSelect.value;
      if (!presetName) {
        showResult('å‰Šé™¤ã™ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error', 3000);
        return;
      }
      
      if (!confirm('ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ' + presetName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ' + presetName + 'ã€ã‚’å‰Šé™¤ä¸­...', 'loading');
      deletePresetBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.status === 'success') {
            showResult('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success', 3000);
            applySettingsToForm({});
            refreshPresets();
          } else {
            onFormCreateFailure(new Error(response.message));
          }
        })
        .withFailureHandler(onFormCreateFailure)
        .deletePresetFromSheet(presetName);
    }
    
    function refreshPresets(selectNameAfterLoad = null) {
      savePresetBtn.disabled = true;
      deletePresetBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler(presets => {
          userPresets = presets || {};
          updatePresetSelect();
          
          savePresetBtn.disabled = false; 
          
          if (selectNameAfterLoad && userPresets[selectNameAfterLoad]) {
            presetSelect.value = selectNameAfterLoad;
            loadSelectedPreset();
          } else if (presetSelect.options.length > 0 && presetSelect.options[0].value) {
            presetSelect.selectedIndex = 0;
            loadSelectedPreset();
          } else {
            loadSelectedPreset(); 
          }
        })
        .withFailureHandler(error => {
          savePresetBtn.disabled = false;
          onFormCreateFailure(error);
        })
        .getPresetsFromSheet();
    }

</script>
</body>
</html>
